<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISRUA Master Topography</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <!-- Esri Leaflet (for Satellite Imagery) -->
    <script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"></script>

    <!-- Leaflet Draw -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <!-- Three.js -->
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
      }
    </script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <link rel="stylesheet" href="css/style.css">
</head>

<body>

    <header>
        <div class="brand">
            <i data-feather="map"></i> SISRUA Master
        </div>
        <div class="header-status">
            <span id="connection-status" class="status-dot success"></span> Connected
        </div>
    </header>

    <div class="main-container">

        <!-- Map Analysis Panel -->
        <div class="floating-panel">
            <div class="panel-section">
                <div class="panel-title">Location Target</div>
                <div class="row">
                    <input type="number" id="lat" placeholder="Latitude (-22.15)" step="0.0001">
                    <input type="number" id="lng" placeholder="Longitude (-42.92)" step="0.0001">
                </div>
                <div class="panel-hint">
                    <i data-feather="crosshair"></i> Click map to update target
                </div>
            </div>

            <div class="panel-section">
                <div class="panel-title">Analysis Parameters</div>
                <div class="input-group">
                    <label for="radius-slider" class="input-label">Radius (meters)</label>
                    <input type="range" id="radius-slider" min="100" max="2500" step="50" value="500"
                        title="Analysis Radius">
                    <div class="slider-labels">
                        <span id="radius-val">500m</span>
                        <span id="radius-warning" class="slider-warning"></span>
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label">Quality Mode</label>
                    <select id="quality" title="Topography Detail Quality">
                        <option value="balanced">Balanced (Fast)</option>
                        <option value="high" selected>High Detail (Recommended)</option>
                        <option value="ultra">Ultra (Topography Master)</option>
                    </select>
                </div>
            </div>

            <div class="panel-section">
                <button class="btn btn-primary" id="btn-generate">
                    <span id="btn-text">Generate 3D Model</span>
                    <div class="loader" id="btn-loader" style="display: none;"></div>
                </button>
            </div>

            <div class="panel-section results-section" id="results-section">
                <div class="panel-title">Export & Stats</div>
                <div class="export-row">
                    <button class="btn btn-secondary">
                        <i data-feather="download"></i> DXF
                    </button>
                    <button class="btn btn-secondary">
                        <i data-feather="box"></i> STL
                    </button>
                </div>

                <div class="control-group">
                    <label>DXF Scale</label>
                    <select id="dxf-preset">
                        <option value="1:500">1:500 (High Detail)</option>
                        <option value="1:1000" selected>1:1000 (Standard)</option>
                        <option value="1:2000">1:2000 (Large Area)</option>
                    </select>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-min">0m</div>
                        <div class="stat-label">Min Elev</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-max">0m</div>
                        <div class="stat-label">Max Elev</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-faces">-</div>
                        <div class="stat-label">TIN Faces</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-slope">0°</div>
                        <div class="stat-label">Mean Slope</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-solar">0%</div>
                        <div class="stat-label">Solar Pot.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Left: Map -->
        <div id="map-container"></div>

        <!-- Right: 3D Viewer (Hidden initially) -->
        <div id="viewer-container">
            <div class="viewer-controls">
                <button class="icon-btn active" id="view-mesh">
                    <i data-feather="layers"></i>
                    <div class="tooltip">Terrain Mesh</div>
                </button>
                <button class="icon-btn active" id="view-hydro">
                    <i data-feather="droplet"></i>
                    <div class="tooltip">Hydrology</div>
                </button>
                <button class="icon-btn active" id="view-forest">
                    <i data-feather="tree"></i>
                    <div class="tooltip">Forests</div>
                </button>
                <button class="icon-btn" id="btn-flow-anim">
                    <i data-feather="play"></i>
                    <div class="tooltip">Animação de Fluxo</div>
                </button>
                <button class="layer-btn active">Terreno</button>
                <button class="layer-btn">Satélite</button>
                <div class="layer-check">
                    <input type="checkbox" id="check-hydro">
                    <label for="check-hydro">Hidrologia</label>
                </div>
                <button class="icon-btn" id="view-contours">
                    <i data-feather="hash"></i>
                    <div class="tooltip">Contour Lines</div>
                </button>
                <div class="divider"></div>
                <!-- Vis Modes -->
                <button class="icon-btn active" id="mode-natural">
                    <i data-feather="image"></i>
                    <div class="tooltip">Natural</div>
                </button>
                <button class="icon-btn" id="mode-elevation">
                    <i data-feather="trending-up"></i>
                    <div class="tooltip">Elevation Height</div>
                </button>
                <button class="icon-btn" id="mode-slope">
                    <i data-feather="activity"></i>
                    <div class="tooltip">Slope Steepness</div>
                </button>
                <button class="icon-btn" id="mode-solar">
                    <i data-feather="sun"></i>
                    <div class="tooltip">Solar Exposure</div>
                </button>
                <button class="icon-btn" id="mode-aspect">
                    <i data-feather="compass"></i>
                    <div class="tooltip">Aspect (Orientation)</div>
                </button>
                <button class="icon-btn" id="mode-watershed">
                    <i data-feather="grid"></i>
                    <div class="tooltip">Bacias (Watersheds)</div>
                </button>
                <button class="icon-btn" id="mode-tpi">
                    <i data-feather="maximize"></i>
                    <div class="tooltip">TPI (Ridges/Valleys)</div>
                </button>
                <button class="icon-btn" id="mode-tri">
                    <i data-feather="box"></i>
                    <div class="tooltip">TRI (Ruggedness)</div>
                </button>
                <button class="icon-btn" id="mode-landform">
                    <i data-feather="map"></i>
                    <div class="tooltip">Landforms</div>
                </button>
                <button class="icon-btn" id="mode-cutfill">
                    <i data-feather="move"></i>
                    <div class="tooltip">Terraplanagem (Cut/Fill)</div>
                </button>
                <button class="icon-btn" id="mode-stability">
                    <i data-feather="alert-triangle"></i>
                    <div class="tooltip">Estabilidade de Talude (FoS)</div>
                </button>
                <button class="icon-btn" id="mode-plan-curvature">
                    <i data-feather="shuffle"></i>
                    <div class="tooltip">Curvatura em Planta</div>
                </button>
                <button class="icon-btn" id="mode-profile-curvature">
                    <i data-feather="trending-up"></i>
                    <div class="tooltip">Curvatura de Perfil</div>
                </button>
                <div class="divider"></div>
                <button class="icon-btn">
                    <i data-feather="maximize"></i>
                    <div class="tooltip">Toggle Fullscreen</div>
                </button>
                <div class="divider"></div>
                <button class="icon-btn" id="btn-sim">
                    <i data-feather="sun"></i>
                    <div class="tooltip">Simulações</div>
                </button>
                <button class="icon-btn" id="btn-ruler">
                    <i data-feather="maximize-2"></i>
                    <div class="tooltip">Perfil de Elevação</div>
                </button>
            </div>

            <!-- Dynamic Legend -->
            <div id="dynamic-legend" class="dynamic-legend"></div>

            <!-- Simulation Panel -->
        </div>
    </div>

    <!-- Earthworks Panel (Phase 11) -->
    <div class="simulation-panel" id="earthworks-panel" style="top: 150px; display: none;">
        <div class="panel-title">Platô & Terraplanagem</div>
        <div class="slider-control">
            <div class="slider-label">
                <span>Cota Alvo (Z)</span>
                <span id="target-z-val">0.00m</span>
            </div>
            <input type="range" id="target-z-slider" min="0" max="1000" step="0.5" value="0">
        </div>
        <div class="volume-stats">
            <div class="stat-row">
                <span>Corte:</span>
                <span id="vol-cut">0.00 m³</span>
            </div>
            <div class="stat-row">
                <span>Aterro:</span>
                <span id="vol-fill">0.00 m³</span>
            </div>
            <div class="stat-row highlight">
                <span>Saldo Líquido:</span>
                <span id="vol-net">0.00 m³</span>
            </div>
        </div>
    </div>

    <!-- Profile Panel -->
    <div class="profile-container" id="profile-panel">
        <div class="panel-title" style="margin-bottom: 5px; display: flex; justify-content: space-between;">
            <span>Elevation Profile</span>
            <i data-feather="x" style="cursor: pointer; width: 14px;"></i>
        </div>
        <canvas id="profile-canvas"></canvas>
    </div>
    </div>

    <!-- Status Toast -->
    <div class="status-toast" id="toast">
        <span class="status-dot" id="toast-dot"></span>
        <span id="toast-msg">System Ready</span>
    </div>

    </div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"></script>

    <!-- Main Module -->
    <script type="module" src="js/main.js"></script>
</body>

</html>