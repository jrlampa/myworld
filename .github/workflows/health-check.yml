name: Health Check

on:
  # Run after successful deployment
  workflow_run:
    workflows: ["Deploy to Cloud Run"]
    types:
      - completed
  
  # Run on schedule (every 6 hours)
  schedule:
    - cron: '0 */6 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      service_url:
        description: 'Cloud Run Service URL (optional, will auto-detect if not provided)'
        required: false
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  health-check:
    runs-on: ubuntu-latest
    # Run if deployment was successful or manually triggered
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Get Service URL
        id: get-url
        run: |
          if [ -n "${{ inputs.service_url }}" ]; then
            SERVICE_URL="${{ inputs.service_url }}"
            echo "Using provided service URL: $SERVICE_URL"
          else
            SERVICE_URL=$(gcloud run services describe sisrua-app \
              --region=southamerica-east1 \
              --project=${{ secrets.GCP_PROJECT_ID }} \
              --format='value(status.url)' 2>&1)
            
            if [ $? -ne 0 ]; then
              echo "‚ùå Failed to get service URL"
              echo "Error: $SERVICE_URL"
              exit 1
            fi
            
            echo "Auto-detected service URL: $SERVICE_URL"
          fi
          
          echo "service_url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_ENV

      - name: Wait for Service Warm-up
        run: |
          echo "‚è≥ Waiting 10 seconds for service to warm up..."
          sleep 10

      - name: Test Health Check Endpoint
        run: |
          echo "üè• Testing /health endpoint..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 30 "$SERVICE_URL/health")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "Response: $BODY"
          echo "HTTP Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ Health check endpoint is responding"
          else
            echo "‚ùå Health check endpoint returned HTTP $HTTP_CODE"
            exit 1
          fi

      - name: Test Frontend Loading
        run: |
          echo "üåê Testing frontend (index.html)..."
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "$SERVICE_URL/")
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ Frontend is loading correctly"
          else
            echo "‚ùå Frontend returned HTTP $HTTP_CODE"
            exit 1
          fi

      - name: Test API Endpoints
        run: |
          echo "üîå Testing API endpoints..."
          
          # Test Search API
          echo "Testing /api/search..."
          SEARCH_RESPONSE=$(curl -s -X POST "$SERVICE_URL/api/search" \
            -H "Content-Type: application/json" \
            -d '{"query": "-23.5505, -46.6333"}' \
            -w "\n%{http_code}" --max-time 30)
          
          SEARCH_CODE=$(echo "$SEARCH_RESPONSE" | tail -n 1)
          if [ "$SEARCH_CODE" -eq 200 ]; then
            echo "‚úÖ Search API is working"
          else
            echo "‚ö†Ô∏è Search API returned HTTP $SEARCH_CODE (may be expected)"
          fi
          
          # Test Analyze API (with GROQ)
          echo "Testing /api/analyze..."
          ANALYZE_RESPONSE=$(curl -s -X POST "$SERVICE_URL/api/analyze" \
            -H "Content-Type: application/json" \
            -d '{"stats": {"buildings": 10, "roads": 5, "trees": 20}, "locationName": "Test Location"}' \
            -w "\n%{http_code}" --max-time 30)
          
          ANALYZE_CODE=$(echo "$ANALYZE_RESPONSE" | tail -n 1)
          if [ "$ANALYZE_CODE" -eq 200 ]; then
            echo "‚úÖ AI Analysis API is working"
          else
            echo "‚ö†Ô∏è AI Analysis API returned HTTP $ANALYZE_CODE"
          fi
          
          # Test Elevation Profile API
          echo "Testing /api/elevation/profile..."
          ELEVATION_RESPONSE=$(curl -s -X POST "$SERVICE_URL/api/elevation/profile" \
            -H "Content-Type: application/json" \
            -d '{"start": {"lat": -23.5505, "lng": -46.6333}, "end": {"lat": -23.5506, "lng": -46.6334}, "steps": 10}' \
            -w "\n%{http_code}" --max-time 30)
          
          ELEVATION_CODE=$(echo "$ELEVATION_RESPONSE" | tail -n 1)
          if [ "$ELEVATION_CODE" -eq 200 ]; then
            echo "‚úÖ Elevation Profile API is working"
          else
            echo "‚ö†Ô∏è Elevation Profile API returned HTTP $ELEVATION_CODE"
          fi

      - name: Test DXF Generation
        run: |
          echo "üìê Testing DXF generation..."
          
          DXF_RESPONSE=$(curl -s -X POST "$SERVICE_URL/api/dxf" \
            -H "Content-Type: application/json" \
            -d '{"lat": -23.5505, "lon": -46.6333, "radius": 100, "mode": "circle"}' \
            -w "\n%{http_code}" --max-time 30)
          
          DXF_CODE=$(echo "$DXF_RESPONSE" | tail -n 1)
          DXF_BODY=$(echo "$DXF_RESPONSE" | head -n -1)
          
          # DXF generation should return 202 (Accepted) or 200 (immediate in dev)
          if [ "$DXF_CODE" -eq 202 ] || [ "$DXF_CODE" -eq 200 ]; then
            echo "‚úÖ DXF Generation API is working (HTTP $DXF_CODE)"
            echo "Response: $DXF_BODY"
            
            # Try to extract job ID if present
            JOB_ID=$(echo "$DXF_BODY" | grep -o '"jobId":"[^"]*"' | cut -d'"' -f4)
            if [ -n "$JOB_ID" ]; then
              echo "Job ID: $JOB_ID"
              echo "JOB_ID=$JOB_ID" >> $GITHUB_ENV
            fi
          else
            echo "‚ùå DXF Generation API returned HTTP $DXF_CODE"
            exit 1
          fi

      - name: Test Cloud Tasks Processing
        if: env.JOB_ID != ''
        run: |
          echo "‚è≥ Testing Cloud Tasks job processing..."
          echo "Job ID: $JOB_ID"
          
          # Wait a bit for job to process
          sleep 5
          
          # Check job status
          JOB_RESPONSE=$(curl -s "$SERVICE_URL/api/jobs/$JOB_ID" \
            -w "\n%{http_code}" --max-time 30)
          
          JOB_CODE=$(echo "$JOB_RESPONSE" | tail -n 1)
          JOB_BODY=$(echo "$JOB_RESPONSE" | head -n -1)
          
          if [ "$JOB_CODE" -eq 200 ]; then
            echo "‚úÖ Job status endpoint is working"
            echo "Job status: $JOB_BODY"
          else
            echo "‚ö†Ô∏è Job status returned HTTP $JOB_CODE"
          fi

      - name: Test Static Assets
        run: |
          echo "üì¶ Testing static assets..."
          
          # Test theme CSS
          CSS_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "$SERVICE_URL/theme-override.css")
          
          if [ "$CSS_CODE" -eq 200 ]; then
            echo "‚úÖ Theme CSS is accessible"
          else
            echo "‚ö†Ô∏è Theme CSS returned HTTP $CSS_CODE"
          fi

      - name: Test API Documentation
        run: |
          echo "üìö Testing API documentation..."
          
          DOCS_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "$SERVICE_URL/api-docs/")
          
          if [ "$DOCS_CODE" -eq 200 ]; then
            echo "‚úÖ Swagger API docs are accessible"
          else
            echo "‚ö†Ô∏è API docs returned HTTP $DOCS_CODE"
          fi

      - name: Comprehensive Health Check
        run: |
          echo "üè• Running comprehensive health check script..."
          node .github/scripts/health-check.js "$SERVICE_URL"

      - name: Health Check Summary
        if: always()
        run: |
          echo ""
          echo "================================================"
          echo "üìä Health Check Summary"
          echo "================================================"
          echo "Service URL: $SERVICE_URL"
          echo "Status: ${{ job.status }}"
          echo ""
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ All health checks passed!"
            echo ""
            echo "Verified:"
            echo "  ‚úÖ Health check endpoint"
            echo "  ‚úÖ Frontend loading"
            echo "  ‚úÖ API endpoints responding"
            echo "  ‚úÖ DXF generation working"
            echo "  ‚úÖ AI analysis functional"
            echo "  ‚úÖ Elevation profiles loading"
            echo "  ‚úÖ Cloud Tasks processing"
            echo "  ‚úÖ Static assets accessible"
          else
            echo "‚ùå Some health checks failed"
            echo "Please review the logs above for details"
          fi
          echo "================================================"
