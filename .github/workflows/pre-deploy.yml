name: Pre-Deploy Checks

on:
  pull_request:
    branches:
      - main
      - production
      - release/alpha-release
  workflow_dispatch:
  workflow_call:

permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: sisrua_unified

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: npm
          cache-dependency-path: sisrua_unified/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate required files
        run: |
          test -f Dockerfile || (echo "Missing Dockerfile" && exit 1)
          test -f py_engine/requirements.txt || (echo "Missing py_engine/requirements.txt" && exit 1)
          test -f tsconfig.server.json || (echo "Missing tsconfig.server.json" && exit 1)
          test -f server/index.ts || (echo "Missing server/index.ts" && exit 1)
          test -d src || (echo "Missing src directory" && exit 1)

      - name: Validate required secrets
        env:
          GCP_WIF_PROVIDER: ${{ secrets.GCP_WIF_PROVIDER }}
          GCP_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
          CLOUD_RUN_BASE_URL: ${{ secrets.CLOUD_RUN_BASE_URL }}
        run: |
          [ -n "$GCP_WIF_PROVIDER" ] || (echo "Missing secret: GCP_WIF_PROVIDER" && exit 1)
          [ -n "$GCP_SERVICE_ACCOUNT" ] || (echo "Missing secret: GCP_SERVICE_ACCOUNT" && exit 1)
          [ -n "$GCP_PROJECT_ID" ] || (echo "Missing secret: GCP_PROJECT_ID" && exit 1)
          [ -n "$GROQ_API_KEY" ] || (echo "Missing secret: GROQ_API_KEY" && exit 1)
          [ -n "$GCP_PROJECT" ] || (echo "Missing secret: GCP_PROJECT" && exit 1)
          [ -n "$CLOUD_RUN_BASE_URL" ] || (echo "Missing secret: CLOUD_RUN_BASE_URL" && exit 1)

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: TypeScript server build check
        run: npx tsc -p tsconfig.server.json

      - name: Frontend build check
        run: npm run build

      - name: Docker build check
        run: docker build -t sisrua-app:predeploy .