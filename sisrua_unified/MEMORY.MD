# sisRUA MEMORY.MD â€” MemÃ³ria de Trabalho RAG

> **LEIA ESTE ARQUIVO ANTES DE QUALQUER AÃ‡ÃƒO.** Este arquivo Ã© o "cÃ©rebro" do projeto â€”
> atualizado a cada sessÃ£o de desenvolvimento. Sempre reflita as mudanÃ§as aqui.

---

## 1. VISÃƒO GERAL DO PROJETO

**Nome:** sisRUA Unified  
**Tipo:** SaaS Enterprise â€” ExportaÃ§Ã£o de dados OSM â†’ DXF 2.5D  
**Objetivo:** Transformar dados geoespaciais pÃºblicos (OpenStreetMap) em plantas urbanas CAD prontas para uso profissional em engenharia, arquitetura e planejamento urbano.  
**VersÃ£o atual:** 1.0.0 (ver `VERSION`, gerenciar via `./scripts/update-version.sh`)  
**Stack primÃ¡rio:** React 19 + TypeScript (frontend) | Express + TypeScript (backend) | Python 3.12 (engine)

---

## 2. REGRAS NÃƒO NEGOCIÃVEIS (RNN)

Estas regras sÃ£o absolutas. Todo cÃ³digo, PR e decisÃ£o deve segui-las:

| # | Regra | Detalhe |
|---|-------|---------|
| 1 | **Branch de desenvolvimento** | Apenas `dev` (ou branches `feature/*` com PR para `dev`) |
| 2 | **Sem dados mockados** | Todo teste usa APIs reais ou fixtures baseadas em dados reais |
| 3 | **2.5D â€” nunca 3D** | Geometria DXF usa extrusÃ£o Z (thickness), nÃ£o modelos 3D reais |
| 4 | **Thin frontend / Smart backend** | Frontend exibe; backend processa e valida |
| 5 | **Zero custo** | Apenas APIs pÃºblicas/gratuitas (OSM, IBGE, DNIT, INCRA, Open-Elevation) |
| 6 | **Docker first** | Todo serviÃ§o deve rodar via Docker; `docker compose up` = ambiente pronto |
| 7 | **Arquitetura DDD** | Domain â†’ Application â†’ Infrastructure â†’ Interfaces |
| 8 | **Modularidade** | Arquivos > 500 linhas devem ser divididos em mÃ³dulos |
| 9 | **Responsabilidade Ãºnica** | Cada arquivo/classe/funÃ§Ã£o = uma responsabilidade |
| 10 | **SanitizaÃ§Ã£o de dados** | Todo input externo deve ser validado (Zod no backend, pyproj/shapely no Python) |
| 11 | **Interface em pt-BR** | Toda a UI deve estar em PortuguÃªs do Brasil |
| 12 | **SeguranÃ§a** | Rate limiting, CORS, sem secrets hardcoded, input sanitization |
| 13 | **Testes** | Unit tests + E2E (Playwright) + testes especÃ­ficos de DXF (headless) |
| 14 | **Half-way BIM** | Atributos semÃ¢nticos no DXF (layers nomeadas, anotaÃ§Ãµes, blocos) |
| 15 | **Sem 3D** | Usar apenas `thickness` (extrusÃ£o 2.5D) â€” NUNCA entidades 3D nativas |

---

## 3. COORDENADAS CANÃ”NICAS DE TESTE

Estas coordenadas sÃ£o usadas em todos os testes automatizados e verificaÃ§Ãµes:

```
UTM Zona 23K: E=788547, N=7634925   â†’ raio 100m
WGS84:  lat=-22.15018, lon=-42.92185 â†’ raios 500m e 1km
RegiÃ£o: MuriaÃ©/MG, Brasil
```

**Fonte da verdade:** `py_engine/constants.py` (`TEST_LAT`, `TEST_LON`, `TEST_UTM_E`, `TEST_UTM_N`, `TEST_RADII`)

---

## 4. ARQUITETURA (DDD)

```
sisrua_unified/
â”œâ”€â”€ server/                     # Backend (Express + TypeScript)
â”‚   â”œâ”€â”€ domain/                 # Entidades, value objects, interfaces de repositÃ³rio
â”‚   â”œâ”€â”€ application/            # Use cases, serviÃ§os de aplicaÃ§Ã£o
â”‚   â”œâ”€â”€ infrastructure/         # ImplementaÃ§Ãµes: Firestore, Cloud Tasks, cache
â”‚   â”œâ”€â”€ interfaces/             # Controladores HTTP (routes/)
â”‚   â”œâ”€â”€ routes/                 # Roteadores Express (interface layer)
â”‚   â”œâ”€â”€ services/               # ServiÃ§os de domÃ­nio/aplicaÃ§Ã£o
â”‚   â”œâ”€â”€ middleware/             # Auth, rate limiting
â”‚   â”œâ”€â”€ schemas/                # ValidaÃ§Ã£o Zod
â”‚   â”œâ”€â”€ utils/                  # UtilitÃ¡rios transversais (logger)
â”‚   â””â”€â”€ tests/                  # Testes unitÃ¡rios do backend
â”‚
â”œâ”€â”€ py_engine/                  # Motor Python (DXF + OSM + Geoespacial)
â”‚   â”œâ”€â”€ controller.py           # Orquestrador do fluxo OSMâ†’DXF
â”‚   â”œâ”€â”€ dxf_generator.py        # Classe principal DXFGenerator
â”‚   â”œâ”€â”€ dxf_drawing.py          # Mixin: desenho de geometrias (polÃ­gonos, linhas, pontos)
â”‚   â”œâ”€â”€ dxf_cartography.py      # Mixin: legenda, carimbo, grade de coordenadas
â”‚   â”œâ”€â”€ dxf_abnt.py             # Conformidade ABNT NBR 8196/10582/13142 (escala, carimbo)
â”‚   â”œâ”€â”€ dxf_styles.py           # Estilos CAD (layers, linetypes, texto)
â”‚   â”œâ”€â”€ osmnx_client.py         # Cliente OSM (via osmnx)
â”‚   â”œâ”€â”€ elevation_client.py     # Cliente de elevaÃ§Ã£o (Open-Elevation)
â”‚   â”œâ”€â”€ contour_generator.py    # GeraÃ§Ã£o de curvas de nÃ­vel
â”‚   â”œâ”€â”€ spatial_audit.py        # Auditoria espacial GIS
â”‚   â”œâ”€â”€ constants.py            # Constantes globais do projeto
â”‚   â”œâ”€â”€ utils/                  # logger.py, geo.py
â”‚   â””â”€â”€ tests/                  # Testes unitÃ¡rios Python (pytest)
â”‚
â”œâ”€â”€ src/                        # Frontend (React + TypeScript)
â”‚   â”œâ”€â”€ App.tsx                 # Componente raiz
â”‚   â”œâ”€â”€ components/             # Componentes UI
â”‚   â”œâ”€â”€ hooks/                  # Custom hooks (lÃ³gica de estado)
â”‚   â”œâ”€â”€ services/               # Chamadas de API
â”‚   â”œâ”€â”€ utils/                  # UtilitÃ¡rios frontend
â”‚   â”œâ”€â”€ types.ts                # Tipos TypeScript globais
â”‚   â””â”€â”€ constants.ts            # Constantes frontend
â”‚
â”œâ”€â”€ e2e/                        # Testes E2E (Playwright)
â”œâ”€â”€ scripts/                    # Scripts de automaÃ§Ã£o
â”œâ”€â”€ public/                     # Assets estÃ¡ticos
â”œâ”€â”€ Dockerfile                  # Multi-stage build (Ubuntu 24.04)
â””â”€â”€ docker-compose.yml          # Ambiente de desenvolvimento local
```

---

## 5. TECH STACK

### Frontend
- **React 19** + TypeScript 5.8
- **Leaflet** + React-Leaflet (mapas 2D/2.5D)
- **Framer Motion** (animaÃ§Ãµes)
- **Tailwind CSS** (styling)
- **Recharts** (grÃ¡ficos de elevaÃ§Ã£o)
- **Vite 6** (bundler)

### Backend
- **Express 4** + TypeScript
- **Zod** (validaÃ§Ã£o de schemas)
- **Winston** (logging)
- **Swagger/OpenAPI** (documentaÃ§Ã£o API)
- **Google Cloud Firestore** (persistÃªncia jobs)
- **Google Cloud Tasks** (processamento assÃ­ncrono)
- **GROQ SDK** (anÃ¡lise IA â€” gratuito no tier free)
- **python-shell** (bridge Nodeâ†’Python)

### Motor Python
- **osmnx 2.x** â€” download de dados OSM
- **ezdxf 1.4+** â€” geraÃ§Ã£o de arquivos DXF
- **geopandas / shapely** â€” processamento geoespacial
- **pyproj** â€” transformaÃ§Ã£o de coordenadas (SIRGAS 2000 UTM)
- **scipy / numpy** â€” matemÃ¡tica de terreno e contornos
- **matplotlib** â€” visualizaÃ§Ã£o (offline)

### Infraestrutura
- **Docker** + Docker Compose
- **Google Cloud Run** (produÃ§Ã£o)
- **GitHub Actions** (CI/CD)

---

## 6. APIs PÃšBLICAS/GRATUITAS UTILIZADAS

| ServiÃ§o | URL | Uso |
|---------|-----|-----|
| OpenStreetMap (Overpass) | via osmnx | Dados geoespaciais |
| Nominatim | nominatim.openstreetmap.org | GeocodificaÃ§Ã£o |
| Open-Elevation | api.open-elevation.com | MDT/ElevaÃ§Ã£o |
| IBGE API | servicodados.ibge.gov.br | Dados municipais/censitÃ¡rios BR |
| DNIT | api.dnit.gov.br | Rodovias federais BR |
| INCRA | acervofundiario.incra.gov.br | Dados fundiÃ¡rios BR |
| GROQ | api.groq.com | IA (tier gratuito) |

**Regra de ouro:** ZERO CUSTO. Nunca adicionar API paga sem aprovaÃ§Ã£o explÃ­cita.

---

## 7. FLUXO DE GERAÃ‡ÃƒO DXF

```
UsuÃ¡rio â†’ MapSelector (Frontend)
    â†’ useDxfExport hook
        â†’ POST /api/dxf/generate
            â†’ pythonBridge.ts â†’ main.py â†’ controller.py
                1. _build_tags() â€” OSM tags solicitadas
                2. fetch_osm_data() â€” osmnx_client.py
                3. run_spatial_audit() â€” spatial_audit.py
                4. DXFGenerator.add_features() â€” dxf_generator.py
                    â†’ DXFDrawingMixin (polÃ­gonos, linhas, pontos)
                    â†’ Z-thickness para 2.5D (edificaÃ§Ãµes)
                5. _process_terrain() â€” elevation_client.py + contour_generator.py
                6. _add_cad_essentials() â€” dxf_cartography.py (legenda, carimbo, grade)
                7. dxf_gen.save() â†’ arquivo .dxf
                8. _export_csv_metadata() â†’ metadata .csv
            â† streaming de progresso via JSON (Logger.progress)
        â† URL de download do arquivo DXF
    â† Download no browser
```

---

## 8. CONVENÃ‡Ã•ES DE CÃ“DIGO

### Python (py_engine)
- **Imports:** sempre usar try/except para imports relativos vs absolutos (compatibilidade pytest)
- **Logging:** usar `Logger.info/error/success()` (nunca `print()`)
- **Coordenadas:** sempre validar com `_safe_v()` e `_safe_p()` antes de criar entidades DXF
- **Layers DXF:** prefixo `sisRUA_` em todos os layers (ex: `sisRUA_EDIFICACAO`)
- **Geometria:** shapely para cÃ¡lculos, ezdxf para saÃ­da
- **CRS:** SIRGAS 2000 UTM (pyproj), funÃ§Ã£o `sirgas2000_utm_epsg()` em `utils/geo.py`

### TypeScript (server)
- **ValidaÃ§Ã£o:** Zod schemas em `server/schemas/`
- **Logging:** Winston logger via `server/utils/logger.ts`
- **Erros:** sempre tratar erros com tipos explÃ­citos
- **Async:** async/await, nunca callbacks raw

### TypeScript (frontend)
- **Estado:** custom hooks para lÃ³gica; componentes apenas para renderizaÃ§Ã£o
- **Idioma:** pt-BR em toda a UI (labels, mensagens, tooltips)
- **Temas:** dark/light via `settings.theme`

---

## 9. LAYERS DXF (REFERÃŠNCIA)

Layers criados por `dxf_styles.py` (`DXFStyleManager.setup_layers`):

| Constante (constants.py) | Layer DXF | DescriÃ§Ã£o |
|--------------------------|-----------|-----------|
| `LAYER_EDIFICACAO` | `EDIFICACAO` | EdificaÃ§Ãµes (com thickness 2.5D) |
| `LAYER_VEGETACAO` | `VEGETACAO` | VegetaÃ§Ã£o (Ã¡rvores, bosques) |
| `LAYER_EQUIPAMENTOS` | `EQUIPAMENTOS` | Equipamentos urbanos |
| `LAYER_HIDROGRAFIA` | `HIDROGRAFIA` | Corpos d'Ã¡gua |
| `LAYER_INFRA_POWER_HV` | `INFRA_POWER_HV` | Linhas de alta tensÃ£o |
| `LAYER_INFRA_POWER_LV` | `INFRA_POWER_LV` | Linhas de baixa tensÃ£o |
| `LAYER_INFRA_TELECOM` | `INFRA_TELECOM` | Infraestrutura telecom |
| `LAYER_MOBILIARIO_URBANO` | `MOBILIARIO_URBANO` | MobiliÃ¡rio urbano |
| `LAYER_VIAS` | `VIAS` | Todas as vias (hierarquia via espessura) |
| `LAYER_VIAS_MEIO_FIO` | `VIAS_MEIO_FIO` | Meio-fio (curb offset) |
| `LAYER_TEXTO` | `TEXTO` | Textos e anotaÃ§Ãµes |
| `LAYER_QUADRO` | `QUADRO` | Carimbo/quadro do projeto |
| _(interno)_ | `EDIFICACAO_HATCH` | Hatch interior de edificaÃ§Ãµes |
| _(interno)_ | `ANNOT_AREA` | AnotaÃ§Ãµes de Ã¡rea |
| _(interno)_ | `ANNOT_LENGTH` | AnotaÃ§Ãµes de comprimento |
| _(interno)_ | `MALHA_COORD` | Grade de coordenadas |
| _(interno)_ | `TOPOGRAFIA_CURVAS` | Curvas topogrÃ¡ficas |
| _(interno)_ | `CURVAS_NIVEL_MESTRA` | Curvas de nÃ­vel mestras |
| _(interno)_ | `CURVAS_NIVEL_INTERM` | Curvas de nÃ­vel intermediÃ¡rias |
| _(interno)_ | `LEGENDA` | Legenda tÃ©cnica |

---

## 10. PAPÃ‰IS DE DESENVOLVIMENTO (ROLES)

### ðŸŽ¯ Tech Lead (Orquestrador)
- ResponsÃ¡vel: arquitetura geral, decisÃµes tÃ©cnicas, revisÃ£o de PRs
- Contexto: mantÃ©m esta MEMORY.MD atualizada
- Ferramentas: design patterns, DDD, revisÃ£o de cÃ³digo

### ðŸ’» Dev Fullstack SÃªnior (Principal Coder)
- ResponsÃ¡vel: implementaÃ§Ã£o de features, refatoraÃ§Ã£o, manutenÃ§Ã£o
- Regras: segue RNN, escreve testes, atualiza MEMORY.MD ao finalizar
- Ferramentas: TypeScript, Python, React, Express

### ðŸ”§ DevOps/QA
- ResponsÃ¡vel: CI/CD, Docker, testes automatizados, seguranÃ§a
- Regras: garante que todos os testes passam antes de merge
- Ferramentas: GitHub Actions, Docker, pytest, Jest, Playwright

### ðŸŽ¨ UI/UX Designer
- ResponsÃ¡vel: interfaces, componentes visuais, experiÃªncia do usuÃ¡rio
- Regras: sempre em pt-BR, Tailwind CSS, acessibilidade
- Ferramentas: React, Framer Motion, Tailwind, Lucide

### ðŸ’¡ EstagiÃ¡rio (Criatividade)
- ResponsÃ¡vel: sugestÃµes inovadoras, POCs, pesquisas
- Regras: propostas passam pela revisÃ£o do Tech Lead antes de implementar
- Contexto: pensar fora da caixa; zero burocracia para ideias

---

## 11. ESTADO ATUAL DO PROJETO

### âœ… Implementado e Funcionando
- [x] Motor Python DXF (py_engine) â€” modular (drawing, cartography, styles)
- [x] Controller OSM â†’ DXF (controller.py)
- [x] Auditoria espacial (spatial_audit.py)
- [x] ElevaÃ§Ã£o + curvas de nÃ­vel (elevation_client.py, contour_generator.py)
- [x] Backend Express com todas as rotas modulares
- [x] Firestore com circuit breaker (quota monitoring)
- [x] Cloud Tasks para processamento assÃ­ncrono
- [x] Frontend React completo (MapSelector, AppSidebar, Settings, Landing)
- [x] Coordenadas de teste canÃ´nicas em constants.py
- [x] 61 testes Python (pytest) â€” todos passando (era 41)
- [x] **78 testes Python** (pytest) â€” todos passando (era 61); contour_generator + logger + elevation_exception
- [x] **206 testes backend** (Jest) â€” todos passando (era 198); cobertura 97.65% stmts, 86.48% branches
- [x] `batchService.ts` 100% cobertura (era 55.55% branch)
- [x] `dxfCleanupService.ts` 100% function coverage (setInterval callback coberto via fake timers)
- [x] `geocodingService.ts` 89.74% branch (utmToLatLon testado com inputs invÃ¡lidos e coords canÃ´nicas)
- [x] `analyticsService.ts` 97.61% statements (buffer circular MAX_EVENTS coberto)
- [x] **Bug corrigido: contour_generator.py** â€” API deprecated `cs.collections` â†’ `cs.allsegs` (matplotlib >= 3.8)
- [x] 187 testes backend (Jest) â€” todos passando (era 156)
- [x] Cobertura backend > 94% (94.86% statements) â€” apÃ³s adiÃ§Ã£o de novos serviÃ§os cobertos
- [x] elevationService.ts: 100% cobertura
- [x] ibgeService.ts: 96.73% cobertura
- [x] rateLimiter.ts: 81.81% cobertura
- [x] cloudTasksService.ts: 95.16% cobertura, 100% de funÃ§Ãµes cobertas
- [x] dnitService.ts: 100% statements/lines cobertura (novo: analyticsRoutes.test.ts + dnitService.test.ts + incraService.test.ts)
- [x] incraService.ts: 100% statements/lines cobertura (novo)
- [x] **exportsByMode no AnalyticsSummary** â€” nova mÃ©trica diferenciando exportaÃ§Ãµes por modo (circle vs polygon)
- [x] E2E tests (Playwright) â€” configurados
- [x] Docker multi-stage (Ubuntu 24.04, Node 22, Python 3.12)
- [x] Swagger/OpenAPI documentation
- [x] Rate limiting e CORS
- [x] GitHub Actions (CI/CD, auto-healing)
- [x] SIRGAS 2000 UTM CRS (pyproj)
- [x] Batch processing (CSV upload)
- [x] APIs brasileiras (IBGE, DNIT, INCRA)
- [x] Headless DXF validation via ezdxf audit
- [x] **OtimizaÃ§Ã£o de queries OSM para Ã¡reas grandes (>1km)** â€” `osmnx_client.py` com `_fetch_chunked()`: busca por grupos de tags, deduplicaÃ§Ã£o, fallback por grupo; 20 novos testes unitÃ¡rios (test_osmnx_client.py)
- [x] **Dashboard de analytics de uso (SaaS metrics)** â€” `server/services/analyticsService.ts` (in-memory, extensÃ­vel Firestore); rota `GET /api/analytics`; `src/components/AnalyticsDashboard.tsx` (pt-BR, dark/light, charts Recharts); integraÃ§Ã£o em `AppSidebar.tsx` via abas ANÃLISE/MÃ‰TRICAS; 14 novos testes unitÃ¡rios (analyticsService.test.ts)
- [x] **PersistÃªncia de mÃ©tricas de analytics em Firestore** â€” `analyticsService.ts`: `persistToFirestore()` (fire-and-forget, circuit breaker), `initFromFirestore()` (carga na inicializaÃ§Ã£o), `initAnalyticsFromFirestore()` exportada; `server/index.ts` chama init em produÃ§Ã£o; 7 novos testes (analyticsFirestore.test.ts); backend 149â†’156 testes
- [x] **Cobertura de testes expandida para serviÃ§os sem testes** â€” 3 novos arquivos de teste: `dxfCleanupService.test.ts` (8 testes, 95% cobertura), `jobStatusService.test.ts` (12 testes, 89% cobertura), `analysisService.test.ts` (10 testes, 100% cobertura); backend 157â†’187 testes; `analysisService.ts` agora com 100% de cobertura
- [x] **Cobertura de testes aprimorada â€” caminhos de erro e timers** â€” `analyticsRoutes.test.ts`: +2 testes para catch blocks (analytics e events 500 error); `nominatimService.test.ts`: +4 testes (coords invÃ¡lidas, catch reverseGeocode, display_name ausente, importance=0); `rateLimiter.test.ts`: +1 teste handler dxfRateLimiter; `jobStatusService.test.ts`: +2 testes fake timer (cleanup interval); backend 187â†’198 testes; cobertura 94.86%â†’97.06% statements; `nominatimService.ts` e `analytics.ts` agora 100% cobertura; `jobStatusService.ts` 98.18% (era 89.09%)
- [x] **ABNT NBR 8196/10582/13142 compliance** â€” novo mÃ³dulo `dxf_abnt.py`: `compute_abnt_scale()` (escala padrÃ£o), `select_paper_size()` (A0-A4 automÃ¡tico), `ABNTTitleBlock` (carimbo completo com todos os campos NBR 10582); `dxf_cartography.py` atualizado para usar `ABNTTitleBlock`; `dxf_generator.py` passa extensÃ£o real para cÃ¡lculo de escala; `main.py` + `pythonBridge.ts` + `dxfRequest.ts` + Swagger com novos campos ABNT (designer, numero_desenho, revisao, verificado_por, aprovado_por); `test_dxf_abnt.py` (32 testes); Python 78â†’110 testes; `rateLimiter.ts` 100% stmt/funcs/lines (generalRateLimiter handler coberto); Backend 206â†’207 testes; cobertura 97.65%â†’97.94% stmts, 98.05%â†’99.02% funcs
- [x] **Cobertura enterprise â€” 214 testes backend, 93.05% branches**: `analyticsService.ts` **100% stmt/branch/lines** (era 97.61%/84.61%); `ibgeService.ts` **100% stmt/branch/lines** (era 96.73%/73.21%); +7 novos testes: USE_FIRESTORE=true branches (record() + initAnalyticsFromFirestore()), mapMunicipio com dados incompletos (fallbacks `?? 0`), getEstados sem regiao, extractCentroid com geometry nula, FeatureCollection malformada, getEstados non-array; cobertura total: 98.68% stmts, **93.05% branches** (era 86.48%), 99.21% lines
- [x] **Cobertura DXF engine Python â€” 179 testes, dxf_generator 94%**: novo `test_dxf_drawing.py` (69 testes): `TestDetermineLayer` (14 tags OSMâ†’layer), `TestMergeContiguousLines` (7 fusÃµes), `TestAddTerrainFromGrid` (6), `TestAddContourLines` (4), `TestDrawGeometry` (9 tipos geomÃ©tricos + coords canÃ´nicas), `TestDrawPoint` (10 layers/tags), `TestDrawStreetOffsets` (6 tipos de via), `TestDrawLinestring` (3), `TestAddFeaturesIntegration` (5 integraÃ§Ã£o com audit headless); `cacheService.ts` **100% branch** (layers null/undefined â†’ `{}`); `incraService.ts` 88.46%â†’92.3% branch (getParcelasSummary default radius); Python 110â†’**179 testes**; `dxf_generator.py` 57%â†’**94%**; `dxf_drawing.py` 70%â†’**78%**; backend 217 testes, branches 93.05%â†’**93.82%**
- [x] **Bugfix Logger.warn + cobertura cartografia/auditoria â€” 213 Python, 220 backend, rateLimiter 100%**: **Bug crÃ­tico corrigido** â€” `Logger.warn()` ausente na classe Logger (AttributeError em produÃ§Ã£o quando concat fallback disparado); novo `test_dxf_cartography.py` (29 testes): `TestAddCartographicElements` (3), `TestAddCoordinateGrid` (5), `TestAddLegend` (4), `TestAddTitleBlock` (8 com audit headless, todos raios canÃ´nicos), `TestCartographyIntegration` (1); `test_spatial_audit.py` +14 testes: `TestCombineAnalysisFeatures` (4, cobre linhas 123/129-131), `TestCalculateLightingScore` (4, cobre linha 141), `TestAuditPowerLineProximity` (1, cobre linhas 115-117), `TestRunSpatialAuditEdgeCases` (3); `test_logger.py` +1 (test_warn_outputs_json); `rateLimiter.test.ts` +1 (req.ip undefined â†’ "unknown", cobre linha 38); `dxfCleanupService.test.ts`/`jobStatusService.test.ts` +1 cada (idempotÃªncia); Python 179â†’**213 testes**; `dxf_cartography.py` 57%â†’**89%**; `spatial_audit.py` 84%â†’**95%**; `rateLimiter.ts` branches 87.5%â†’**100%**; Python total 80%â†’**83%**; backend 217â†’**220 testes**, branches 93.82%â†’**94.2%**
- [x] **Frontend hooks 45â†’105 testes (SotA) â€” geo.ts 100%, useUndoRedo 100%, kmlParser 97%, useOsmEngine 100%**: Novos: `tests/hooks/useUndoRedo.test.ts` (22 testes, state machine completo undo/redo); `tests/utils/kmlParser.test.ts` (8 testes, FileReader mock via vi.stubGlobal, KML vÃ¡lido/invÃ¡lido/edge-cases); `tests/utils/geo.test.ts` (19 testes, UTM 23K canÃ´nico, hemisfÃ©rios N/S, zonas invÃ¡lidas 0/61, regex edge-cases); `tests/hooks/useOsmEngine.test.ts` (11 testes, todas as branches: success/empty/error, AI on/off, clearData, setOsmData); Backend +4: `geocodingService` zona 0/61/99 (linha 48); `incraService` `id:undefined` â†’ `?? ''` (96.15% branch); Frontend 45â†’**105**; `useUndoRedo` **100%** all; `geo.ts` **100%** stmts; `kmlParser` **97%**; `useOsmEngine` **100%** stmts; backend 220â†’**224**

### ðŸ”„ Em Desenvolvimento / Melhorias Pendentes
_(sem itens pendentes no momento)_

---

## 12. COMANDOS ESSENCIAIS

```bash
# Desenvolvimento local
npm run docker:dev          # Inicia ambiente completo Docker
npm run dev                 # Frontend + Backend (sem Docker)

# Testes
npm run test:backend        # Jest (224 testes, 98.82% stmts, 94.98% branches)
npm run test:frontend       # Vitest (163 testes, 95.55% stmts, 89.91% branches)
npm run test:e2e            # Playwright
cd py_engine && python3 -m pytest tests/ -v  # Python (252 testes, 86% cobertura)

# Build e Deploy
npm run build               # Build frontend
npm run docker:build        # Build imagem Docker
./scripts/update-version.sh # Atualiza versÃ£o

# SeguranÃ§a
npm run security:audit      # npm audit
python scripts/security_audit.py  # Bandit security scan

# DXF Headless (alternativa ao accoreconsole)
python -c "import ezdxf; doc=ezdxf.readfile('arquivo.dxf'); a=doc.audit(); print(f'{len(a.errors)} erros')"
```

---

## 13. VARIÃVEIS DE AMBIENTE

```env
# Backend (.env)
PORT=3001
NODE_ENV=development|production
GROQ_API_KEY=                    # GROQ AI (gratuito)
GCP_PROJECT=sisrua-producao      # Google Cloud Project
CLOUD_TASKS_LOCATION=southamerica-east1
CLOUD_TASKS_QUEUE=sisrua-queue
CLOUD_RUN_BASE_URL=              # URL do Cloud Run (produÃ§Ã£o)
DOCKER_ENV=true                  # Indica ambiente Docker

# Python (via server bridge)
PYTHON_COMMAND=python3
PYTHONUNBUFFERED=1
PYTHONDONTWRITEBYTECODE=1
```

---

## 14. GLOSSÃRIO

| Termo | Significado |
|-------|-------------|
| DXF | Drawing Exchange Format â€” formato CAD (AutoCAD) |
| 2.5D | Geometria 2D com extrusÃ£o Z (thickness) â€” simula 3D em DXF |
| OSM | OpenStreetMap â€” fonte de dados geoespaciais abertos |
| UTM | Universal Transverse Mercator â€” sistema de projeÃ§Ã£o cartogrÃ¡fica |
| SIRGAS 2000 | Sistema de ReferÃªncia GeocÃªntrico para as AmÃ©ricas â€” datum oficial BR |
| BIM | Building Information Modeling â€” modelo com informaÃ§Ãµes semÃ¢nticas |
| DDD | Domain-Driven Design â€” arquitetura orientada ao domÃ­nio |
| RAG | Retrieval Augmented Generation â€” base de conhecimento para IA |
| carimbo | Quadro de identificaÃ§Ã£o do projeto em plantas CAD |
| meio-fio | Guia/sarjeta â€” offset lateral de vias (curb) |

---

## 15. HISTÃ“RICO DE SESSÃ•ES

| Data | AÃ§Ã£o | ResponsÃ¡vel |
|------|------|-------------|
| 2026-02-21 | CriaÃ§Ã£o deste MEMORY.MD; verificaÃ§Ã£o de testes (98 passando) | Dev Fullstack SÃªnior |
| 2026-02-21 | ElevaÃ§Ã£o cobertura backend de 79% â†’ 93.22%; testes 74â†’100: ElevationService (100%), IbgeService (96.73%), RateLimiter (81.81%); getMunicipiosPorEstado/getMalhaGeoJson/extractCentroid testados | Dev Fullstack SÃªnior |
| 2026-02-21 | OSM query optimization: `_fetch_chunked()` em osmnx_client.py (chunked fetching para radius >1km); 20 novos testes (test_osmnx_client.py); cloudTasksService cobertura 85%â†’95% (+3 testes: dev mode, error path, getTaskStatus); Python 41â†’61 testes, Backend 100â†’103 testes, cobertura 93.22%â†’94.79% | Dev Fullstack SÃªnior |
| 2026-02-21 | **Analytics Dashboard SaaS**: `analyticsService.ts` (in-memory, singleton, prune 7d, cluster regiÃµes, top5); rota `/api/analytics`; `AnalyticsDashboard.tsx` (pt-BR, dark/light, KPI cards, grÃ¡ficos por hora/tipo/status, top regiÃµes, eventos recentes); `AppSidebar.tsx` com abas ANÃLISE/MÃ‰TRICAS; `src/services/analyticsService.ts` (cliente fetch); instrumentaÃ§Ã£o em `routes/dxf.ts`; 14 novos testes (117 total backend); TypeScript compila sem erros | Dev Fullstack SÃªnior |
| 2026-02-21 | **ExpansÃ£o de testes e mÃ©tricas**: `exportsByMode` em `AnalyticsSummary` (circle vs polygon); 3 novos arquivos de teste: `analyticsRoutes.test.ts` (integraÃ§Ã£o HTTP), `dnitService.test.ts` (16 testes, 100% cobertura), `incraService.test.ts` (14 testes, 100% cobertura); backend 117â†’149 testes, cobertura 94.79%â†’95.37% | Dev Fullstack SÃªnior |
| 2026-02-21 | **PersistÃªncia Firestore para Analytics**: `analyticsService.ts` â€” `persistToFirestore()` (async fire-and-forget, circuit breaker), `initFromFirestore()` (carga de eventos ao startup), `initAnalyticsFromFirestore()` exportada; `server/index.ts` chama init em produÃ§Ã£o; `analyticsFirestore.test.ts` (7 testes); backend 149â†’156 testes | Dev Fullstack SÃªnior |
| 2026-02-21 | **Cobertura expandida â€” 3 novos arquivos de teste**: `dxfCleanupService.test.ts` (8 testes, 95% stmt), `jobStatusService.test.ts` (12 testes, 89% stmt), `analysisService.test.ts` (10 testes, 100% cobertura total); backend 157â†’187 testes; `analysisService.ts` 100% cobertura | Dev Fullstack SÃªnior |
| 2026-02-21 | **Cobertura de caminhos de erro e timers**: analytics catch blocks (+2 testes 500 error em `/api/analytics` e `/api/analytics/events`); nominatim invalid coords/catch/optional fields (+4 testes â†’ 100% cobertura total); rateLimiter handler dxfRateLimiter (+1 teste, 90.9%); jobStatusService cleanup interval com fake timers (+2 testes, 98.18%); backend 187â†’198 testes, cobertura 94.86%â†’97.06% statements | Dev Fullstack SÃªnior |
| 2026-02-21 | **Enterprise improvements â€” cobertura e correÃ§Ã£o de bug crÃ­tico**: `batchService.ts` 100% coverage (erro de stream + valores nÃ£o-string); `dnitService.ts` 91.66% branch (default-radius tests); `dxfCleanupService.ts` 100% funÃ§Ãµes (fake timers, setInterval callback); `geocodingService.ts` 89.74% branch (utmToLatLon zero-inputs + coords canÃ´nicas); `analyticsService.ts` 97.61% (buffer circular MAX_EVENTS); Bug corrigido: `contour_generator.py` â€” `cs.collections` depreciado â†’ `cs.allsegs` (matplotlib >= 3.8); `test_contour_generator.py` (7 testes) + `test_logger.py` (9 testes) + `test_elevation.py` +1 (exception path); Python 61â†’78 testes; Backend 198â†’206 testes; cobertura 97.06%â†’97.65% stmts, 83.39%â†’86.48% branches | Dev Fullstack SÃªnior |
| 2026-02-21 | **ABNT NBR 8196/10582/13142 â€” carimbo tÃ©cnico conforme norma**: novo mÃ³dulo `dxf_abnt.py` (compute_abnt_scale, select_paper_size, ABNTTitleBlock); `dxf_cartography.py` usa ABNTTitleBlock com todos os campos normalizados; `dxf_generator.py` calcula extensÃ£o real para escala; campos ABNT propagados por toda a stack (main.py â†’ pythonBridge.ts â†’ dxfRequest.ts â†’ cloudTasksService.ts â†’ Swagger); `test_dxf_abnt.py` (32 testes); `rateLimiter.ts` 100% cobertura; Python 78â†’110 testes; Backend 206â†’207 testes | Dev Fullstack SÃªnior |
| 2026-02-21 | **Versionamento zerado e coerente**: VERSION â†’ `0.1.0`; novo `server/version.ts` (fonte central SERVER_VERSION); `health.ts`, `index.ts`, `swagger.ts` importam SERVER_VERSION (eliminadas 5 strings hardcoded `1.2.0`); `update-version.sh` e `check-version.sh` atualizados para gerenciar `server/version.ts` + `src/constants.ts`; `tests/version.test.ts` ampliado com 2 novos checks (APP_VERSION e SERVER_VERSION); docs/CHANGELOG.md e docs/RAG.md atualizados | Dev Fullstack SÃªnior |
| 2026-02-21 | **AnÃ¡lise de maturidade â€” correÃ§Ã£o de versÃ£o para 1.0.0**: avaliaÃ§Ã£o tÃ©cnica conclui que `0.1.0` (prÃ©-estÃ¡vel, API instÃ¡vel) Ã© incoerente com a maturidade real do projeto (produÃ§Ã£o Cloud Run, 7 workflows CI/CD, 207 testes backend 97.94% cobertura, 110 testes Python, 18.333+ linhas, DDD completo, APIs governamentais BR, compliance ABNT); VERSION â†’ `1.0.0` (primeiro release estÃ¡vel); CHANGELOG.md atualizado com justificativa tÃ©cnica | Dev Fullstack SÃªnior |
| 2026-02-21 | **Cobertura enterprise â€” 214 testes backend, 93.05% branches**: `analyticsService.ts` 100% stmt/branch/lines; `ibgeService.ts` 100% stmt/branch/lines; +7 novos testes: USE_FIRESTORE=true branches, mapMunicipio fallbacks `?? 0`, getEstados sem regiao, extractCentroid com geometry nula/FeatureCollection malformada; branches: 86.48% â†’ **93.05%**, stmts: 97.94% â†’ **98.68%**, lines: 98.74% â†’ **99.21%** | Dev Fullstack SÃªnior |
| 2026-02-21 | **Cobertura DXF engine Python â€” 179 testes, dxf_generator 94%**: novo `test_dxf_drawing.py` (69 testes); `TestDetermineLayer` (14 tags), `TestMergeContiguousLines` (7), `TestAddTerrainFromGrid` (6), `TestAddContourLines` (4), `TestDrawGeometry` (9), `TestDrawPoint` (10), `TestDrawStreetOffsets` (6), `TestDrawLinestring` (3), `TestAddFeaturesIntegration` (5 com audit headless); `cacheService.ts` 100% branch (null/undefined layers); `incraService.ts` 92.3% branch; Python 110â†’179 testes; dxf_generator 57%â†’94%; dxf_drawing 70%â†’78%; backend 217 testes; branches 93.05%â†’93.82% | Dev Fullstack SÃªnior |
| 2026-02-21 | **Bugfix Logger.warn + cobertura cartografia/auditoria â€” 213 Python, 220 backend**: **Bug crÃ­tico**: `Logger.warn()` inexistente â†’ AttributeError em produÃ§Ã£o (concat fallback); novo `test_dxf_cartography.py` (29 testes, cartographicElements/coordinateGrid/legend/titleBlock+audit headless+3 raios); `test_spatial_audit.py` +14 testes (CombineFeatures/LightingScore/PowerLineException/EdgeCases); `test_logger.py` +1 warn; `rateLimiter.test.ts` +1 (req.ip undefined â†’ "unknown", **rateLimiter.ts 100% branch**); `dxfCleanupService.test.ts`/`jobStatusService.test.ts` +1 cada (idempotÃªncia); Python 179â†’**213**; dxf_cartography 57%â†’**89%**; spatial_audit 84%â†’**95%**; Python total 80%â†’**83%**; backend 217â†’**220**; branches 93.82%â†’**94.2%** | Dev Fullstack SÃªnior |
| 2026-02-21 | **Frontend hooks 45â†’105 testes, geo.ts 100%, useUndoRedo 100%, kmlParser 97%, useOsmEngine 100%**: Novos arquivos: `tests/hooks/useUndoRedo.test.ts` (22 testes: state machine completo, undo/redo multi-step, saveSnapshot, commit=false, objetos complexos); `tests/utils/kmlParser.test.ts` (8 testes: KML vÃ¡lido/invÃ¡lido via vi.stubGlobal FileReader mock, onerror, NaN filtering); `tests/utils/geo.test.ts` (19 testes: UTM 23K, bandas C-M/N-X, zona 0/61 invÃ¡lidas, regex edge cases, normalizaÃ§Ã£o vÃ­rgula); `tests/hooks/useOsmEngine.test.ts` (11 testes: success/empty/error flows, AI on/off, clearData, setOsmData); Backend +4: `geocodingService` zona 0/61/99 â†’ cobre linha 48; `incraService` `id:undefined` â†’ cobre `?? ''` branch (96.15%); Frontend 45â†’**105**; `useUndoRedo` **100%** all metrics; `geo.ts` **100%** stmts; `kmlParser.ts` **97%**; `useOsmEngine.ts` **100%** stmts; backend 220â†’**224** | Dev Fullstack SÃªnior |
| 2026-02-21 | **SotA guards+services â€” 596 total tests: dxf_drawing 97%, dxf_generator 99%, elevationService 100%, logger 98%**: Novo `test_dxf_drawing_guards.py` (39 testes Python): `_safe_v` ValueError/TypeError, `_safe_p` IndexError, `_validate_points` guards (NaN deduplication, non-iterable except 58-60), `_get_thickness` levels/exception, polygon holes (97-100), building annotation/hatch exceptions (118-119/136-137), linestring VIAS exception (162-163), MultiLineString offset via MagicMock (178-179), offset exception, `_draw_point` NaN guard (209), bench/waste/lamp blocks (223-228), NaN bounds fallback (72), `_simplify_line` (114), start-start merge (153), street label exception via `np.arctan2` patch (212-213), bad terrain vertex (252-254), save exception (296-298); Frontend +15: `tests/utils/logger.test.ts` +6 (vi.stubEnv NODE_ENV=development, console.log/warn/error, data arg, debug on/off), `tests/services/elevationService.test.ts` +9 (error/non-ok/invalid response â†’ flat grid, default clamp, lat/lng coords, fetchElevationProfile success/error/non-ok); Python 213â†’**252**; Frontend 105â†’**120**; `dxf_drawing.py` **78%â†’97%**; `dxf_generator.py` **94%â†’99%**; `elevationService.ts` **69%â†’100%** stmts, **64%â†’95%** branch; `logger.ts` **83%â†’98%** stmts, **81%â†’95%** branch; Python total **83%â†’86%**; CodeQL 0 alertas | Dev Fullstack SÃªnior |
| 2026-02-21 | **Coverage>=80% â€” frontend 95.55% stmts, 89.91% branches â€” 639 total tests**: **Bug crÃ­tico de config corrigido**: vitest coverage incluÃ­a `server/` (todos 0%) â†’ overall reportado como 7.5% (ERRADO); fix: `include: ['src/**/*.{ts,tsx}']` + exclude components (testados via E2E Playwright); **Novos testes frontend**: `useFileOperations.test.ts` reescrito (7 testes reais com renderHook: saveProject success/error, loadProject valid/invalid/malformed/onerror); `useDxfExport.test.ts` reescrito (7 testes reais: idle state, url imediata, jobId queued, null result, network error, default projection, getDxfJobStatus); `useSearch.test.ts` +5 (UTM found, lat/lng direct, null response, network error, handleSearch form); Novos arquivos de serviÃ§o: `tests/services/dxfService.test.ts` (12 testes: generateDXF/getDxfJobStatus/calculateStats, 100% cobertura); `tests/services/osmService.test.ts` (4 testes: failover endpoints, 100%); `tests/services/geminiService.test.ts` (10 testes: findLocationWithGemini/analyzeArea AI on/off/error, 100%); `tests/services/analyticsService.test.ts` (3 testes: success/non-ok/network, 100%); Frontend 120â†’**163 testes**; Cobertura frontend: **7.5%â†’95.55% stmts**, **89.91% branches**, **100% funcs**, todos os layers â‰¥ 80% âœ…; useFileOperations.ts 0%â†’94%; useDxfExport.ts 0%â†’60%; useSearch.ts 77%â†’95% stmts, 55%â†’90% branches; dxfService 0%â†’100%; osmService 0%â†’100%; geminiService 0%â†’100%; src/services/analyticsService 0%â†’100%; CodeQL 0 alertas | Dev Fullstack SÃªnior |

---

*Ãšltima atualizaÃ§Ã£o: 2026-02-21 | VersÃ£o do Documento: 2.4*
