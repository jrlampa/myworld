# sisRUA MEMORY.MD ‚Äî Mem√≥ria de Trabalho RAG

> **LEIA ESTE ARQUIVO ANTES DE QUALQUER A√á√ÉO.** Este arquivo √© o "c√©rebro" do projeto ‚Äî
> atualizado a cada sess√£o de desenvolvimento. Sempre reflita as mudan√ßas aqui.

---

## 1. VIS√ÉO GERAL DO PROJETO

**Nome:** sisRUA Unified  
**Tipo:** SaaS Enterprise ‚Äî Exporta√ß√£o de dados OSM ‚Üí DXF 2.5D  
**Objetivo:** Transformar dados geoespaciais p√∫blicos (OpenStreetMap) em plantas urbanas CAD prontas para uso profissional em engenharia, arquitetura e planejamento urbano.  
**Vers√£o atual:** 1.0.0 (ver `VERSION`, gerenciar via `./scripts/update-version.sh`)  
**Stack prim√°rio:** React 19 + TypeScript (frontend) | Express + TypeScript (backend) | Python 3.12 (engine)

---

## 2. REGRAS N√ÉO NEGOCI√ÅVEIS (RNN)

Estas regras s√£o absolutas. Todo c√≥digo, PR e decis√£o deve segui-las:

| # | Regra | Detalhe |
|---|-------|---------|
| 1 | **Branch de desenvolvimento** | Apenas `dev` (ou branches `feature/*` com PR para `dev`) |
| 2 | **Sem dados mockados** | Todo teste usa APIs reais ou fixtures baseadas em dados reais |
| 3 | **2.5D ‚Äî nunca 3D** | Geometria DXF usa extrus√£o Z (thickness), n√£o modelos 3D reais |
| 4 | **Thin frontend / Smart backend** | Frontend exibe; backend processa e valida |
| 5 | **Zero custo** | Apenas APIs p√∫blicas/gratuitas (OSM, IBGE, DNIT, INCRA, Open-Elevation) |
| 6 | **Docker first** | Todo servi√ßo deve rodar via Docker; `docker compose up` = ambiente pronto |
| 7 | **Arquitetura DDD** | Domain ‚Üí Application ‚Üí Infrastructure ‚Üí Interfaces |
| 8 | **Modularidade** | Arquivos > 500 linhas devem ser divididos em m√≥dulos |
| 9 | **Responsabilidade √∫nica** | Cada arquivo/classe/fun√ß√£o = uma responsabilidade |
| 10 | **Sanitiza√ß√£o de dados** | Todo input externo deve ser validado (Zod no backend, pyproj/shapely no Python) |
| 11 | **Interface em pt-BR** | Toda a UI deve estar em Portugu√™s do Brasil |
| 12 | **Seguran√ßa** | Rate limiting, CORS, sem secrets hardcoded, input sanitization |
| 13 | **Testes** | Unit tests + E2E (Playwright) + testes espec√≠ficos de DXF (headless) |
| 14 | **Half-way BIM** | Atributos sem√¢nticos no DXF (layers nomeadas, anota√ß√µes, blocos) |
| 15 | **Sem 3D** | Usar apenas `thickness` (extrus√£o 2.5D) ‚Äî NUNCA entidades 3D nativas |

---

## 3. COORDENADAS CAN√îNICAS DE TESTE

Estas coordenadas s√£o usadas em todos os testes automatizados e verifica√ß√µes:

```
UTM Zona 23K: E=788547, N=7634925   ‚Üí raio 100m
WGS84:  lat=-22.15018, lon=-42.92185 ‚Üí raios 500m e 1km
Regi√£o: Muria√©/MG, Brasil
```

**Fonte da verdade:** `py_engine/constants.py` (`TEST_LAT`, `TEST_LON`, `TEST_UTM_E`, `TEST_UTM_N`, `TEST_RADII`)

---

## 4. ARQUITETURA (DDD)

```
sisrua_unified/
‚îú‚îÄ‚îÄ server/                     # Backend (Express + TypeScript)
‚îÇ   ‚îú‚îÄ‚îÄ domain/                 # Entidades, value objects, interfaces de reposit√≥rio
‚îÇ   ‚îú‚îÄ‚îÄ application/            # Use cases, servi√ßos de aplica√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ infrastructure/         # Implementa√ß√µes: Firestore, Cloud Tasks, cache
‚îÇ   ‚îú‚îÄ‚îÄ interfaces/             # Controladores HTTP (routes/)
‚îÇ   ‚îú‚îÄ‚îÄ routes/                 # Roteadores Express (interface layer)
‚îÇ   ‚îú‚îÄ‚îÄ services/               # Servi√ßos de dom√≠nio/aplica√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ middleware/             # Auth, rate limiting
‚îÇ   ‚îú‚îÄ‚îÄ schemas/                # Valida√ß√£o Zod
‚îÇ   ‚îú‚îÄ‚îÄ utils/                  # Utilit√°rios transversais (logger)
‚îÇ   ‚îî‚îÄ‚îÄ tests/                  # Testes unit√°rios do backend
‚îÇ
‚îú‚îÄ‚îÄ py_engine/                  # Motor Python (DXF + OSM + Geoespacial)
‚îÇ   ‚îú‚îÄ‚îÄ controller.py           # Orquestrador do fluxo OSM‚ÜíDXF
‚îÇ   ‚îú‚îÄ‚îÄ dxf_generator.py        # Classe principal DXFGenerator
‚îÇ   ‚îú‚îÄ‚îÄ dxf_drawing.py          # Mixin: desenho de geometrias (pol√≠gonos, linhas, pontos)
‚îÇ   ‚îú‚îÄ‚îÄ dxf_cartography.py      # Mixin: legenda, carimbo, grade de coordenadas
‚îÇ   ‚îú‚îÄ‚îÄ dxf_styles.py           # Estilos CAD (layers, linetypes, texto)
‚îÇ   ‚îú‚îÄ‚îÄ osmnx_client.py         # Cliente OSM (via osmnx)
‚îÇ   ‚îú‚îÄ‚îÄ elevation_client.py     # Cliente de eleva√ß√£o (Open-Elevation)
‚îÇ   ‚îú‚îÄ‚îÄ contour_generator.py    # Gera√ß√£o de curvas de n√≠vel
‚îÇ   ‚îú‚îÄ‚îÄ spatial_audit.py        # Auditoria espacial GIS
‚îÇ   ‚îú‚îÄ‚îÄ constants.py            # Constantes globais do projeto
‚îÇ   ‚îú‚îÄ‚îÄ utils/                  # logger.py, geo.py
‚îÇ   ‚îî‚îÄ‚îÄ tests/                  # Testes unit√°rios Python (pytest)
‚îÇ
‚îú‚îÄ‚îÄ src/                        # Frontend (React + TypeScript)
‚îÇ   ‚îú‚îÄ‚îÄ App.tsx                 # Componente raiz
‚îÇ   ‚îú‚îÄ‚îÄ components/             # Componentes UI
‚îÇ   ‚îú‚îÄ‚îÄ hooks/                  # Custom hooks (l√≥gica de estado)
‚îÇ   ‚îú‚îÄ‚îÄ services/               # Chamadas de API
‚îÇ   ‚îú‚îÄ‚îÄ utils/                  # Utilit√°rios frontend
‚îÇ   ‚îú‚îÄ‚îÄ types.ts                # Tipos TypeScript globais
‚îÇ   ‚îî‚îÄ‚îÄ constants.ts            # Constantes frontend
‚îÇ
‚îú‚îÄ‚îÄ e2e/                        # Testes E2E (Playwright)
‚îú‚îÄ‚îÄ scripts/                    # Scripts de automa√ß√£o
‚îú‚îÄ‚îÄ public/                     # Assets est√°ticos
‚îú‚îÄ‚îÄ Dockerfile                  # Multi-stage build (Ubuntu 24.04)
‚îî‚îÄ‚îÄ docker-compose.yml          # Ambiente de desenvolvimento local
```

---

## 5. TECH STACK

### Frontend
- **React 19** + TypeScript 5.8
- **Leaflet** + React-Leaflet (mapas 2D/2.5D)
- **Framer Motion** (anima√ß√µes)
- **Tailwind CSS** (styling)
- **Recharts** (gr√°ficos de eleva√ß√£o)
- **Vite 6** (bundler)

### Backend
- **Express 4** + TypeScript
- **Zod** (valida√ß√£o de schemas)
- **Winston** (logging)
- **Swagger/OpenAPI** (documenta√ß√£o API)
- **Google Cloud Firestore** (persist√™ncia jobs)
- **Google Cloud Tasks** (processamento ass√≠ncrono)
- **GROQ SDK** (an√°lise IA ‚Äî gratuito no tier free)
- **python-shell** (bridge Node‚ÜíPython)

### Motor Python
- **osmnx 2.x** ‚Äî download de dados OSM
- **ezdxf 1.4+** ‚Äî gera√ß√£o de arquivos DXF
- **geopandas / shapely** ‚Äî processamento geoespacial
- **pyproj** ‚Äî transforma√ß√£o de coordenadas (SIRGAS 2000 UTM)
- **scipy / numpy** ‚Äî matem√°tica de terreno e contornos
- **matplotlib** ‚Äî visualiza√ß√£o (offline)

### Infraestrutura
- **Docker** + Docker Compose
- **Google Cloud Run** (produ√ß√£o)
- **GitHub Actions** (CI/CD)

---

## 6. APIs P√öBLICAS/GRATUITAS UTILIZADAS

| Servi√ßo | URL | Uso |
|---------|-----|-----|
| OpenStreetMap (Overpass) | via osmnx | Dados geoespaciais |
| Nominatim | nominatim.openstreetmap.org | Geocodifica√ß√£o |
| Open-Elevation | api.open-elevation.com | MDT/Eleva√ß√£o |
| IBGE API | servicodados.ibge.gov.br | Dados municipais/censit√°rios BR |
| DNIT | api.dnit.gov.br | Rodovias federais BR |
| INCRA | acervofundiario.incra.gov.br | Dados fundi√°rios BR |
| GROQ | api.groq.com | IA (tier gratuito) |

**Regra de ouro:** ZERO CUSTO. Nunca adicionar API paga sem aprova√ß√£o expl√≠cita.

---

## 7. FLUXO DE GERA√á√ÉO DXF

```
Usu√°rio ‚Üí MapSelector (Frontend)
    ‚Üí useDxfExport hook
        ‚Üí POST /api/dxf/generate
            ‚Üí pythonBridge.ts ‚Üí main.py ‚Üí controller.py
                1. _build_tags() ‚Äî OSM tags solicitadas
                2. fetch_osm_data() ‚Äî osmnx_client.py
                3. run_spatial_audit() ‚Äî spatial_audit.py
                4. DXFGenerator.add_features() ‚Äî dxf_generator.py
                    ‚Üí DXFDrawingMixin (pol√≠gonos, linhas, pontos)
                    ‚Üí Z-thickness para 2.5D (edifica√ß√µes)
                5. _process_terrain() ‚Äî elevation_client.py + contour_generator.py
                6. _add_cad_essentials() ‚Äî dxf_cartography.py (legenda, carimbo, grade)
                7. dxf_gen.save() ‚Üí arquivo .dxf
                8. _export_csv_metadata() ‚Üí metadata .csv
            ‚Üê streaming de progresso via JSON (Logger.progress)
        ‚Üê URL de download do arquivo DXF
    ‚Üê Download no browser
```

---

## 8. CONVEN√á√ïES DE C√ìDIGO

### Python (py_engine)
- **Imports:** sempre usar try/except para imports relativos vs absolutos (compatibilidade pytest)
- **Logging:** usar `Logger.info/error/success()` (nunca `print()`)
- **Coordenadas:** sempre validar com `_safe_v()` e `_safe_p()` antes de criar entidades DXF
- **Layers DXF:** prefixo `sisRUA_` em todos os layers (ex: `sisRUA_EDIFICACAO`)
- **Geometria:** shapely para c√°lculos, ezdxf para sa√≠da
- **CRS:** SIRGAS 2000 UTM (pyproj), fun√ß√£o `sirgas2000_utm_epsg()` em `utils/geo.py`

### TypeScript (server)
- **Valida√ß√£o:** Zod schemas em `server/schemas/`
- **Logging:** Winston logger via `server/utils/logger.ts`
- **Erros:** sempre tratar erros com tipos expl√≠citos
- **Async:** async/await, nunca callbacks raw

### TypeScript (frontend)
- **Estado:** custom hooks para l√≥gica; componentes apenas para renderiza√ß√£o
- **Idioma:** pt-BR em toda a UI (labels, mensagens, tooltips)
- **Temas:** dark/light via `settings.theme`

---

## 9. LAYERS DXF (REFER√äNCIA)

Layers criados por `dxf_styles.py` (`DXFStyleManager.setup_layers`):

| Constante (constants.py) | Layer DXF | Descri√ß√£o |
|--------------------------|-----------|-----------|
| `LAYER_EDIFICACAO` | `EDIFICACAO` | Edifica√ß√µes (com thickness 2.5D) |
| `LAYER_VEGETACAO` | `VEGETACAO` | Vegeta√ß√£o (√°rvores, bosques) |
| `LAYER_EQUIPAMENTOS` | `EQUIPAMENTOS` | Equipamentos urbanos |
| `LAYER_HIDROGRAFIA` | `HIDROGRAFIA` | Corpos d'√°gua |
| `LAYER_INFRA_POWER_HV` | `INFRA_POWER_HV` | Linhas de alta tens√£o |
| `LAYER_INFRA_POWER_LV` | `INFRA_POWER_LV` | Linhas de baixa tens√£o |
| `LAYER_INFRA_TELECOM` | `INFRA_TELECOM` | Infraestrutura telecom |
| `LAYER_MOBILIARIO_URBANO` | `MOBILIARIO_URBANO` | Mobili√°rio urbano |
| `LAYER_VIAS` | `VIAS` | Todas as vias (hierarquia via espessura) |
| `LAYER_VIAS_MEIO_FIO` | `VIAS_MEIO_FIO` | Meio-fio (curb offset) |
| `LAYER_TEXTO` | `TEXTO` | Textos e anota√ß√µes |
| `LAYER_QUADRO` | `QUADRO` | Carimbo/quadro do projeto |
| _(interno)_ | `EDIFICACAO_HATCH` | Hatch interior de edifica√ß√µes |
| _(interno)_ | `ANNOT_AREA` | Anota√ß√µes de √°rea |
| _(interno)_ | `ANNOT_LENGTH` | Anota√ß√µes de comprimento |
| _(interno)_ | `MALHA_COORD` | Grade de coordenadas |
| _(interno)_ | `TOPOGRAFIA_CURVAS` | Curvas topogr√°ficas |
| _(interno)_ | `CURVAS_NIVEL_MESTRA` | Curvas de n√≠vel mestras |
| _(interno)_ | `CURVAS_NIVEL_INTERM` | Curvas de n√≠vel intermedi√°rias |
| _(interno)_ | `LEGENDA` | Legenda t√©cnica |

---

## 10. PAP√âIS DE DESENVOLVIMENTO (ROLES)

### üéØ Tech Lead (Orquestrador)
- Respons√°vel: arquitetura geral, decis√µes t√©cnicas, revis√£o de PRs
- Contexto: mant√©m esta MEMORY.MD atualizada
- Ferramentas: design patterns, DDD, revis√£o de c√≥digo

### üíª Dev Fullstack S√™nior (Principal Coder)
- Respons√°vel: implementa√ß√£o de features, refatora√ß√£o, manuten√ß√£o
- Regras: segue RNN, escreve testes, atualiza MEMORY.MD ao finalizar
- Ferramentas: TypeScript, Python, React, Express

### üîß DevOps/QA
- Respons√°vel: CI/CD, Docker, testes automatizados, seguran√ßa
- Regras: garante que todos os testes passam antes de merge
- Ferramentas: GitHub Actions, Docker, pytest, Jest, Playwright

### üé® UI/UX Designer
- Respons√°vel: interfaces, componentes visuais, experi√™ncia do usu√°rio
- Regras: sempre em pt-BR, Tailwind CSS, acessibilidade
- Ferramentas: React, Framer Motion, Tailwind, Lucide

### üí° Estagi√°rio (Criatividade)
- Respons√°vel: sugest√µes inovadoras, POCs, pesquisas
- Regras: propostas passam pela revis√£o do Tech Lead antes de implementar
- Contexto: pensar fora da caixa; zero burocracia para ideias

---

## 11. ESTADO ATUAL DO PROJETO

### ‚úÖ Implementado e Funcionando
- [x] Motor Python DXF (py_engine) ‚Äî modular (drawing, cartography, styles)
- [x] Controller OSM ‚Üí DXF (controller.py)
- [x] Auditoria espacial (spatial_audit.py)
- [x] Eleva√ß√£o + curvas de n√≠vel (elevation_client.py, contour_generator.py)
- [x] Backend Express com todas as rotas modulares
- [x] Firestore com circuit breaker (quota monitoring)
- [x] Cloud Tasks para processamento ass√≠ncrono
- [x] Frontend React completo (MapSelector, AppSidebar, Settings, Landing)
- [x] Coordenadas de teste can√¥nicas em constants.py
- [x] 61 testes Python (pytest) ‚Äî todos passando (era 41)
- [x] 117 testes backend (Jest) ‚Äî todos passando (era 103)
- [x] Cobertura backend > 94% (94.79% statements) ‚Äî subiu de 93.22%
- [x] elevationService.ts: 100% cobertura
- [x] ibgeService.ts: 96.73% cobertura
- [x] rateLimiter.ts: 81.81% cobertura
- [x] cloudTasksService.ts: 95.16% cobertura, 100% de fun√ß√µes cobertas (era 85%)
- [x] E2E tests (Playwright) ‚Äî configurados
- [x] Docker multi-stage (Ubuntu 24.04, Node 22, Python 3.12)
- [x] Swagger/OpenAPI documentation
- [x] Rate limiting e CORS
- [x] GitHub Actions (CI/CD, auto-healing)
- [x] SIRGAS 2000 UTM CRS (pyproj)
- [x] Batch processing (CSV upload)
- [x] APIs brasileiras (IBGE, DNIT, INCRA)
- [x] Headless DXF validation via ezdxf audit
- [x] **Otimiza√ß√£o de queries OSM para √°reas grandes (>1km)** ‚Äî `osmnx_client.py` com `_fetch_chunked()`: busca por grupos de tags, deduplica√ß√£o, fallback por grupo; 20 novos testes unit√°rios (test_osmnx_client.py)
- [x] **Dashboard de analytics de uso (SaaS metrics)** ‚Äî `server/services/analyticsService.ts` (in-memory, extens√≠vel Firestore); rota `GET /api/analytics`; `src/components/AnalyticsDashboard.tsx` (pt-BR, dark/light, charts Recharts); integra√ß√£o em `AppSidebar.tsx` via abas AN√ÅLISE/M√âTRICAS; 14 novos testes unit√°rios (analyticsService.test.ts)

### üîÑ Em Desenvolvimento / Melhorias Pendentes
- [ ] Persist√™ncia de m√©tricas de analytics em Firestore (produ√ß√£o)

---

## 12. COMANDOS ESSENCIAIS

```bash
# Desenvolvimento local
npm run docker:dev          # Inicia ambiente completo Docker
npm run dev                 # Frontend + Backend (sem Docker)

# Testes
npm run test:backend        # Jest (100 testes, >93% cobertura)
npm run test:frontend       # Vitest
npm run test:e2e            # Playwright
cd py_engine && python -m pytest tests/ -v  # Python (41 testes)

# Build e Deploy
npm run build               # Build frontend
npm run docker:build        # Build imagem Docker
./scripts/update-version.sh # Atualiza vers√£o

# Seguran√ßa
npm run security:audit      # npm audit
python scripts/security_audit.py  # Bandit security scan

# DXF Headless (alternativa ao accoreconsole)
python -c "import ezdxf; doc=ezdxf.readfile('arquivo.dxf'); a=doc.audit(); print(f'{len(a.errors)} erros')"
```

---

## 13. VARI√ÅVEIS DE AMBIENTE

```env
# Backend (.env)
PORT=3001
NODE_ENV=development|production
GROQ_API_KEY=                    # GROQ AI (gratuito)
GCP_PROJECT=sisrua-producao      # Google Cloud Project
CLOUD_TASKS_LOCATION=southamerica-east1
CLOUD_TASKS_QUEUE=sisrua-queue
CLOUD_RUN_BASE_URL=              # URL do Cloud Run (produ√ß√£o)
DOCKER_ENV=true                  # Indica ambiente Docker

# Python (via server bridge)
PYTHON_COMMAND=python3
PYTHONUNBUFFERED=1
PYTHONDONTWRITEBYTECODE=1
```

---

## 14. GLOSS√ÅRIO

| Termo | Significado |
|-------|-------------|
| DXF | Drawing Exchange Format ‚Äî formato CAD (AutoCAD) |
| 2.5D | Geometria 2D com extrus√£o Z (thickness) ‚Äî simula 3D em DXF |
| OSM | OpenStreetMap ‚Äî fonte de dados geoespaciais abertos |
| UTM | Universal Transverse Mercator ‚Äî sistema de proje√ß√£o cartogr√°fica |
| SIRGAS 2000 | Sistema de Refer√™ncia Geoc√™ntrico para as Am√©ricas ‚Äî datum oficial BR |
| BIM | Building Information Modeling ‚Äî modelo com informa√ß√µes sem√¢nticas |
| DDD | Domain-Driven Design ‚Äî arquitetura orientada ao dom√≠nio |
| RAG | Retrieval Augmented Generation ‚Äî base de conhecimento para IA |
| carimbo | Quadro de identifica√ß√£o do projeto em plantas CAD |
| meio-fio | Guia/sarjeta ‚Äî offset lateral de vias (curb) |

---

## 15. HIST√ìRICO DE SESS√ïES

| Data | A√ß√£o | Respons√°vel |
|------|------|-------------|
| 2026-02-21 | Cria√ß√£o deste MEMORY.MD; verifica√ß√£o de testes (98 passando) | Dev Fullstack S√™nior |
| 2026-02-21 | Eleva√ß√£o cobertura backend de 79% ‚Üí 93.22%; testes 74‚Üí100: ElevationService (100%), IbgeService (96.73%), RateLimiter (81.81%); getMunicipiosPorEstado/getMalhaGeoJson/extractCentroid testados | Dev Fullstack S√™nior |
| 2026-02-21 | OSM query optimization: `_fetch_chunked()` em osmnx_client.py (chunked fetching para radius >1km); 20 novos testes (test_osmnx_client.py); cloudTasksService cobertura 85%‚Üí95% (+3 testes: dev mode, error path, getTaskStatus); Python 41‚Üí61 testes, Backend 100‚Üí103 testes, cobertura 93.22%‚Üí94.79% | Dev Fullstack S√™nior |
| 2026-02-21 | **Analytics Dashboard SaaS**: `analyticsService.ts` (in-memory, singleton, prune 7d, cluster regi√µes, top5); rota `/api/analytics`; `AnalyticsDashboard.tsx` (pt-BR, dark/light, KPI cards, gr√°ficos por hora/tipo/status, top regi√µes, eventos recentes); `AppSidebar.tsx` com abas AN√ÅLISE/M√âTRICAS; `src/services/analyticsService.ts` (cliente fetch); instrumenta√ß√£o em `routes/dxf.ts`; 14 novos testes (117 total backend); TypeScript compila sem erros | Dev Fullstack S√™nior |

---

*√öltima atualiza√ß√£o: 2026-02-21 | Vers√£o do Documento: 1.1*
